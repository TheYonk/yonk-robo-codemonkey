# RoboMonkey MCP - Docker Compose Configuration
# Generated by install.sh
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose logs -f            # View logs
#   docker compose down               # Stop all services
#   docker compose run --rm mcp       # Run MCP server interactively

services:
  # PostgreSQL with pgvector - stores the indexed codebase
  postgres:
    image: pgvector/pgvector:pg16
    container_name: robomonkey-postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-robomonkey}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/01_init_schema.sql:ro
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d robomonkey"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # Local Embedding Service - lightweight CPU-based sentence-transformers
  embeddings:
    build:
      context: ./embedding-service
      dockerfile: Dockerfile
    container_name: robomonkey-embeddings
    environment:
      EMBEDDING_PORT: 8082
      DEFAULT_EMBEDDING_MODEL: all-mpnet-base-v2
    ports:
      - "${EMBEDDINGS_PORT:-8082}:8082"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8082/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # RoboMonkey Daemon - background processing (embeddings, summaries, watching)
  daemon:
    build:
      context: .
      dockerfile: docker-deploy/Dockerfile.daemon
    container_name: robomonkey-daemon
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-robomonkey}
      EMBEDDINGS_PROVIDER: ${EMBEDDINGS_PROVIDER:-ollama}
      EMBEDDINGS_MODEL: ${EMBEDDINGS_MODEL:-snowflake-arctic-embed2:latest}
      EMBEDDINGS_BASE_URL: ${EMBEDDINGS_BASE_URL:-http://ollama:11434}
      EMBEDDINGS_DIMENSION: ${EMBEDDINGS_DIMENSION:-1024}
      DEFAULT_REPO: ${DEFAULT_REPO:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - ./config:/app/config:ro
      - source_code:/source:ro
    depends_on:
      postgres:
        condition: service_healthy
      embeddings:
        condition: service_healthy
    restart: unless-stopped

  # RoboMonkey MCP Server - provides code search tools to IDEs
  mcp:
    build:
      context: .
      dockerfile: docker-deploy/Dockerfile.mcp
    container_name: robomonkey-mcp
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-robomonkey}
      EMBEDDINGS_PROVIDER: ${EMBEDDINGS_PROVIDER:-ollama}
      EMBEDDINGS_MODEL: ${EMBEDDINGS_MODEL:-snowflake-arctic-embed2:latest}
      EMBEDDINGS_BASE_URL: ${EMBEDDINGS_BASE_URL:-http://ollama:11434}
      EMBEDDINGS_DIMENSION: ${EMBEDDINGS_DIMENSION:-1024}
      DEFAULT_REPO: ${DEFAULT_REPO:-}
    depends_on:
      postgres:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles:
      - mcp  # Only start with: docker compose run --rm mcp

  # RoboMonkey Web UI - admin panel
  webui:
    build:
      context: .
      dockerfile: docker-deploy/Dockerfile.webui
    container_name: robomonkey-webui
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-robomonkey}
    ports:
      - "${WEBUI_PORT:-9832}:9832"
    depends_on:
      postgres:
        condition: service_healthy
    profiles:
      - webui  # Only start with: docker compose --profile webui up -d
    restart: unless-stopped

volumes:
  pgdata:
    name: robomonkey_pgdata
  ollama_data:
    name: robomonkey_ollama
  source_code:
    name: robomonkey_source

networks:
  default:
    name: robomonkey_network
