{% extends "base.html" %}

{% block title %}Code Explorer - RoboMonkey{% endblock %}

{% block content %}
<!-- View Mode Tabs -->
<div class="mb-6 border-b border-slate-700">
    <nav class="flex space-x-4">
        <button
            id="tab-repo-view"
            onclick="switchExplorerView('repo')"
            class="px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-400"
        >
            Repository Explorer
        </button>
        <button
            id="tab-table-view"
            onclick="switchExplorerView('table')"
            class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200"
        >
            Database Tables
        </button>
    </nav>
</div>

<!-- Repository Explorer View -->
<div id="view-repo" class="grid grid-cols-12 gap-6">
    <!-- Sidebar: Repo Selection + File Tree -->
    <div class="col-span-3">
        <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-4 mb-4">
            <label class="block text-sm font-medium text-slate-300 mb-2">Repository</label>
            <select
                id="repo-select"
                class="w-full rounded-md bg-slate-700 border-slate-600 text-slate-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                onchange="loadRepoOverview(this.value)"
            >
                <option value="">Select repository...</option>
            </select>
        </div>

        <!-- Repo Stats Card -->
        <div id="repo-stats-card" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-4 mb-4" style="display: none;">
            <h3 class="text-lg font-semibold text-slate-100 mb-3">Statistics</h3>
            <div id="repo-stats-content" class="space-y-2 text-sm">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- File Tree -->
        <div id="file-tree-card" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-4" style="display: none;">
            <h3 class="text-lg font-semibold text-slate-100 mb-3">Files</h3>
            <div id="file-tree" class="overflow-y-auto text-sm" style="max-height: calc(100vh - 500px);">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="col-span-9">
        <!-- Empty State -->
        <div id="repo-empty-state" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-12 text-center">
            <h3 class="text-lg font-medium text-slate-100 mb-2">Select a Repository</h3>
            <p class="text-slate-400">Choose a repository from the dropdown to explore its contents, symbols, and relationships</p>
        </div>

        <!-- Repo Overview -->
        <div id="repo-overview" style="display: none;">
            <!-- Sub-navigation tabs -->
            <div class="mb-4 border-b border-slate-700">
                <nav class="flex space-x-4">
                    <button onclick="switchRepoTab('overview')" id="repo-tab-overview" class="repo-tab px-3 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-400">Overview</button>
                    <button onclick="switchRepoTab('symbols')" id="repo-tab-symbols" class="repo-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200">Browse Symbols</button>
                    <button onclick="switchRepoTab('summaries')" id="repo-tab-summaries" class="repo-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200">File Summaries</button>
                </nav>
            </div>

            <!-- Overview Tab Content -->
            <div id="repo-tab-content-overview">
                <!-- Languages -->
                <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-slate-100 mb-4">Languages</h3>
                    <div id="languages-chart" class="flex flex-wrap gap-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Symbol Types -->
                <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-slate-100 mb-4">Symbol Types</h3>
                    <div id="symbol-types-chart" class="grid grid-cols-4 gap-4">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Key Symbols -->
                <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-slate-100 mb-4">Key Symbols</h3>
                    <div id="symbol-list" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Tags -->
                <div id="tags-section" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6" style="display: none;">
                    <h3 class="text-lg font-semibold text-slate-100 mb-4">Tags</h3>
                    <div id="tags-list" class="flex flex-wrap gap-2">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Symbols Browser Tab Content -->
            <div id="repo-tab-content-symbols" style="display: none;">
                <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-slate-100">Browse Symbols</h3>
                        <div class="flex gap-2">
                            <select id="symbol-filter-type" onchange="filterSymbols()" class="rounded-md bg-slate-700 border-slate-600 text-slate-100 text-sm">
                                <option value="">All Types</option>
                                <option value="function">Functions</option>
                                <option value="class">Classes</option>
                                <option value="method">Methods</option>
                                <option value="interface">Interfaces</option>
                            </select>
                            <input type="text" id="symbol-search" placeholder="Search symbols..." oninput="filterSymbols()" class="rounded-md bg-slate-700 border-slate-600 text-slate-100 text-sm px-3 py-1 w-48">
                        </div>
                    </div>
                    <div id="symbols-browser-list" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>
                    <div id="symbols-browser-pagination" class="mt-4 flex justify-between items-center text-sm text-slate-400">
                        <!-- Pagination -->
                    </div>
                </div>
            </div>

            <!-- File Summaries Tab Content -->
            <div id="repo-tab-content-summaries" style="display: none;">
                <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-slate-100 mb-4">File Summaries</h3>
                    <p class="text-sm text-slate-400 mb-4">AI-generated summaries of files in this repository</p>
                    <div id="file-summaries-list" class="space-y-4">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- File Detail View -->
        <div id="file-detail" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6" style="display: none;">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="file-detail-title" class="text-lg font-semibold text-slate-100"></h3>
                    <p id="file-detail-path" class="text-sm text-slate-400 font-mono"></p>
                </div>
                <button onclick="hideFileDetail()" class="text-slate-400 hover:text-slate-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="file-symbols" class="space-y-3">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Symbol Detail View -->
        <div id="symbol-detail" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6" style="display: none;">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="symbol-detail-name" class="text-xl font-semibold text-slate-100"></h3>
                    <p id="symbol-detail-meta" class="text-sm text-slate-400"></p>
                </div>
                <button onclick="hideSymbolDetail()" class="text-slate-400 hover:text-slate-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <!-- Callers -->
            <div id="symbol-callers" class="mb-4">
                <h4 class="text-sm font-semibold text-slate-300 mb-2">Called By</h4>
                <div id="symbol-callers-list" class="space-y-1"></div>
            </div>
            <!-- Callees -->
            <div id="symbol-callees" class="mb-4">
                <h4 class="text-sm font-semibold text-slate-300 mb-2">Calls</h4>
                <div id="symbol-callees-list" class="space-y-1"></div>
            </div>
            <!-- Summary -->
            <div id="symbol-summary-section" style="display: none;">
                <h4 class="text-sm font-semibold text-slate-300 mb-2">Summary</h4>
                <p id="symbol-summary-text" class="text-sm text-slate-400"></p>
            </div>
        </div>
    </div>
</div>

<!-- Database Table View (hidden by default) -->
<div id="view-table" class="grid grid-cols-12 gap-6" style="display: none;">
    <!-- Sidebar -->
    <div class="col-span-3">
        <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-4">
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">Schema</label>
                <select
                    id="schema-select"
                    class="w-full rounded-md bg-slate-700 border-slate-600 text-slate-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    onchange="loadTables(this.value)"
                >
                    <option value="">Select schema...</option>
                </select>
            </div>

            <div id="table-list" class="space-y-2 overflow-y-auto" style="max-height: calc(100vh - 250px);">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-span-9">
        <div id="table-empty-state" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-12 text-center">
            <h3 class="text-lg font-medium text-slate-100 mb-2">Select a Schema</h3>
            <p class="text-slate-400">Choose a schema from the dropdown to explore its tables</p>
        </div>

        <div id="table-view-content" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-slate-100" id="table-title"></h3>
                    <p class="text-sm text-slate-400" id="table-info"></p>
                </div>
                <button onclick="exportCSV()" class="bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded">
                    Export CSV
                </button>
            </div>

            <div class="overflow-x-auto">
                <table id="data-table" class="min-w-full divide-y divide-slate-700">
                    <thead class="bg-slate-700">
                        <tr id="table-header"></tr>
                    </thead>
                    <tbody id="table-body" class="bg-slate-800 divide-y divide-slate-700"></tbody>
                </table>
            </div>

            <div class="mt-4 flex justify-between items-center">
                <div id="pagination-info" class="text-sm text-slate-400"></div>
                <div id="pagination-controls" class="flex gap-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Row Detail Modal -->
<div id="row-detail-modal" class="fixed inset-0 z-50 hidden" aria-modal="true">
    <div class="fixed inset-0 bg-black/60" onclick="closeRowDetail()"></div>
    <div class="fixed inset-y-0 right-0 w-1/2 bg-slate-800 border-l border-slate-700 shadow-xl flex flex-col">
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700">
            <h3 class="text-lg font-semibold text-slate-100" id="detail-title">Row Details</h3>
            <button onclick="closeRowDetail()" class="text-slate-400 hover:text-slate-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="detail-content" class="flex-1 overflow-y-auto p-6">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// State
let currentRepoName = null;
let currentSchema = null;
let currentTable = null;
let currentPage = 0;
const pageSize = 50;
let currentRows = [];

document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([
        loadRepoList(),
        loadSchemas()
    ]);
});

// View switching
function switchExplorerView(view) {
    const repoView = document.getElementById('view-repo');
    const tableView = document.getElementById('view-table');
    const tabRepo = document.getElementById('tab-repo-view');
    const tabTable = document.getElementById('tab-table-view');

    if (view === 'repo') {
        repoView.style.display = 'grid';
        tableView.style.display = 'none';
        tabRepo.className = 'px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-400';
        tabTable.className = 'px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200';
    } else {
        repoView.style.display = 'none';
        tableView.style.display = 'grid';
        tabRepo.className = 'px-4 py-3 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200';
        tabTable.className = 'px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-400';
    }
}

// ========== Repository Explorer ==========

let allSymbols = [];
let filteredSymbols = [];
let symbolsPage = 0;
const symbolsPageSize = 50;

async function loadRepoList() {
    try {
        const response = await fetch('/api/repos');
        const data = await response.json();

        const select = document.getElementById('repo-select');
        data.repositories.forEach(repo => {
            const option = document.createElement('option');
            option.value = repo.name;
            option.textContent = `${repo.name} (${repo.stats?.files || 0} files)`;
            select.appendChild(option);
        });

        // Auto-select if only one
        if (data.repositories.length === 1) {
            select.value = data.repositories[0].name;
            loadRepoOverview(data.repositories[0].name);
        }
    } catch (error) {
        console.error('Error loading repos:', error);
    }
}

// Repo sub-tab switching
function switchRepoTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.repo-tab').forEach(btn => {
        btn.className = 'repo-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-200';
    });
    document.getElementById(`repo-tab-${tab}`).className = 'repo-tab px-3 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-400';

    // Show/hide content
    document.getElementById('repo-tab-content-overview').style.display = tab === 'overview' ? 'block' : 'none';
    document.getElementById('repo-tab-content-symbols').style.display = tab === 'symbols' ? 'block' : 'none';
    document.getElementById('repo-tab-content-summaries').style.display = tab === 'summaries' ? 'block' : 'none';

    // Load data if needed
    if (tab === 'symbols' && allSymbols.length === 0) {
        loadSymbolsBrowser();
    }
    if (tab === 'summaries') {
        loadFileSummaries();
    }
}

async function loadRepoOverview(repoName) {
    if (!repoName) {
        document.getElementById('repo-empty-state').style.display = 'block';
        document.getElementById('repo-overview').style.display = 'none';
        document.getElementById('repo-stats-card').style.display = 'none';
        document.getElementById('file-tree-card').style.display = 'none';
        return;
    }

    currentRepoName = repoName;

    try {
        const response = await fetch(`/api/repos/${repoName}/stats`);
        const data = await response.json();

        // Show overview
        document.getElementById('repo-empty-state').style.display = 'none';
        document.getElementById('repo-overview').style.display = 'block';
        document.getElementById('repo-stats-card').style.display = 'block';
        document.getElementById('file-tree-card').style.display = 'block';
        document.getElementById('file-detail').style.display = 'none';
        document.getElementById('symbol-detail').style.display = 'none';

        // Populate stats
        const statsContent = document.getElementById('repo-stats-content');
        statsContent.innerHTML = `
            <div class="flex justify-between"><span class="text-slate-400">Files:</span><span class="text-slate-100">${data.stats.files}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Symbols:</span><span class="text-slate-100">${data.stats.symbols}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Chunks:</span><span class="text-slate-100">${data.stats.chunks}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Embeddings:</span><span class="text-slate-100">${data.stats.embeddings}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Edges:</span><span class="text-slate-100">${data.stats.edges}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Documents:</span><span class="text-slate-100">${data.stats.documents}</span></div>
        `;

        // Populate languages
        const languagesChart = document.getElementById('languages-chart');
        if (data.languages && data.languages.length > 0) {
            languagesChart.innerHTML = data.languages.map(lang => `
                <div class="px-3 py-2 bg-slate-700 rounded-lg">
                    <span class="font-medium text-slate-100">${lang.language}</span>
                    <span class="text-slate-400 ml-2">${lang.count} files</span>
                </div>
            `).join('');
        } else {
            languagesChart.innerHTML = '<p class="text-slate-500">No language data available</p>';
        }

        // Populate symbol types
        const symbolTypesChart = document.getElementById('symbol-types-chart');
        if (data.symbol_types && data.symbol_types.length > 0) {
            symbolTypesChart.innerHTML = data.symbol_types.map(st => {
                const icon = getSymbolIcon(st.type);
                return `
                    <div class="bg-slate-700 rounded-lg p-4 text-center">
                        <div class="text-2xl mb-1">${icon}</div>
                        <div class="text-lg font-bold text-slate-100">${st.count}</div>
                        <div class="text-xs text-slate-400">${st.type}</div>
                    </div>
                `;
            }).join('');
        } else {
            symbolTypesChart.innerHTML = '<p class="text-slate-500 col-span-4">No symbol data available</p>';
        }

        // Load files and symbols
        await Promise.all([
            loadFileTree(repoName),
            loadKeySymbols(repoName),
            loadRepoTags(repoName)
        ]);

    } catch (error) {
        console.error('Error loading repo overview:', error);
    }
}

function getSymbolIcon(kind) {
    const icons = {
        'function': '<svg class="w-6 h-6 inline text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>',
        'class': '<svg class="w-6 h-6 inline text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>',
        'method': '<svg class="w-6 h-6 inline text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>',
        'interface': '<svg class="w-6 h-6 inline text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
        'module': '<svg class="w-6 h-6 inline text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path></svg>'
    };
    return icons[kind] || '<span class="text-slate-400">?</span>';
}

async function loadFileTree(repoName) {
    try {
        // Use the list_files MCP tool
        const response = await fetch('/api/mcp/tools/list_files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ params: { repo: repoName, limit: 100 } })
        });
        const data = await response.json();

        const fileTree = document.getElementById('file-tree');
        if (data.result && data.result.files) {
            // Group by directory
            const dirs = {};
            data.result.files.forEach(f => {
                const parts = f.path.split('/');
                const dir = parts.slice(0, -1).join('/') || '/';
                if (!dirs[dir]) dirs[dir] = [];
                dirs[dir].push(f);
            });

            let html = '';
            for (const [dir, files] of Object.entries(dirs).slice(0, 10)) {
                html += `
                    <div class="mb-3">
                        <div class="text-slate-400 text-xs font-mono mb-1">${dir || '/'}</div>
                        ${files.slice(0, 5).map(f => `
                            <button
                                onclick="showFileDetail('${encodeURIComponent(f.path)}')"
                                class="block w-full text-left px-2 py-1 text-sm text-slate-300 hover:bg-slate-700 rounded truncate"
                                title="${f.path}"
                            >
                                ${f.path.split('/').pop()}
                                <span class="text-slate-500 text-xs">(${f.symbols || 0})</span>
                            </button>
                        `).join('')}
                        ${files.length > 5 ? `<span class="text-xs text-slate-500 pl-2">+${files.length - 5} more</span>` : ''}
                    </div>
                `;
            }
            fileTree.innerHTML = html || '<p class="text-slate-500">No files found</p>';
        } else {
            fileTree.innerHTML = '<p class="text-slate-500">No files indexed yet</p>';
        }
    } catch (error) {
        console.error('Error loading file tree:', error);
        document.getElementById('file-tree').innerHTML = '<p class="text-red-400">Error loading files</p>';
    }
}

async function loadKeySymbols(repoName) {
    try {
        // Search for key symbols using hybrid_search
        const response = await fetch('/api/mcp/tools/hybrid_search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                params: {
                    query: 'main function class handler',
                    repo: repoName,
                    final_top_k: 10,
                    entity_types: 'symbol'
                }
            })
        });
        const data = await response.json();

        const symbolList = document.getElementById('symbol-list');
        if (data.result && data.result.results && data.result.results.length > 0) {
            symbolList.innerHTML = data.result.results.map(r => `
                <div class="p-3 bg-slate-700 rounded-lg hover:bg-slate-600 transition cursor-pointer" onclick="loadSymbolDetail('${r.symbol_id || ''}', '${escapeJs(r.fqn || r.name || r.title)}')">
                    <div class="flex items-center gap-2">
                        ${getSymbolIcon(r.kind || 'function')}
                        <span class="font-medium text-slate-100">${escapeHtml(r.name || r.title || 'Unknown')}</span>
                        <span class="text-xs text-slate-500">${r.kind || ''}</span>
                    </div>
                    <div class="text-xs text-slate-400 font-mono mt-1 truncate">${escapeHtml(r.file_path || '')}</div>
                    ${r.signature ? `<code class="text-xs text-slate-500 block mt-1 truncate">${escapeHtml(r.signature)}</code>` : ''}
                </div>
            `).join('');
        } else {
            symbolList.innerHTML = '<p class="text-slate-500">No symbols found. Try indexing your repository first.</p>';
        }
    } catch (error) {
        console.error('Error loading symbols:', error);
        document.getElementById('symbol-list').innerHTML = '<p class="text-red-400">Error loading symbols</p>';
    }
}

async function loadRepoTags(repoName) {
    try {
        const response = await fetch('/api/mcp/tools/list_tags', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ params: {} })
        });
        const data = await response.json();

        const tagsSection = document.getElementById('tags-section');
        const tagsList = document.getElementById('tags-list');

        if (data.result && data.result.tags && data.result.tags.length > 0) {
            tagsSection.style.display = 'block';
            tagsList.innerHTML = data.result.tags.map(tag => `
                <span class="px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-sm cursor-pointer hover:bg-slate-600" title="${escapeHtml(tag.description || '')}">
                    ${escapeHtml(tag.name)}
                </span>
            `).join('');
        } else {
            tagsSection.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading tags:', error);
    }
}

// ========== Symbols Browser ==========

async function loadSymbolsBrowser() {
    if (!currentRepoName) return;

    const list = document.getElementById('symbols-browser-list');
    list.innerHTML = '<p class="text-slate-400">Loading symbols...</p>';

    try {
        // Use hybrid_search to get symbols
        const response = await fetch('/api/mcp/tools/hybrid_search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                params: {
                    query: '*',
                    repo: currentRepoName,
                    final_top_k: 200,
                    entity_types: 'symbol'
                }
            })
        });
        const data = await response.json();

        if (data.result && data.result.results) {
            allSymbols = data.result.results;
            filteredSymbols = [...allSymbols];
            renderSymbolsBrowser();
        } else {
            list.innerHTML = '<p class="text-slate-500">No symbols found. Index your repository first.</p>';
        }
    } catch (error) {
        console.error('Error loading symbols:', error);
        list.innerHTML = '<p class="text-red-400">Error loading symbols</p>';
    }
}

function filterSymbols() {
    const typeFilter = document.getElementById('symbol-filter-type').value;
    const searchQuery = document.getElementById('symbol-search').value.toLowerCase();

    filteredSymbols = allSymbols.filter(s => {
        const matchesType = !typeFilter || s.kind === typeFilter;
        const matchesSearch = !searchQuery ||
            (s.name && s.name.toLowerCase().includes(searchQuery)) ||
            (s.file_path && s.file_path.toLowerCase().includes(searchQuery));
        return matchesType && matchesSearch;
    });

    symbolsPage = 0;
    renderSymbolsBrowser();
}

function renderSymbolsBrowser() {
    const list = document.getElementById('symbols-browser-list');
    const pagination = document.getElementById('symbols-browser-pagination');

    const start = symbolsPage * symbolsPageSize;
    const pageSymbols = filteredSymbols.slice(start, start + symbolsPageSize);

    if (pageSymbols.length === 0) {
        list.innerHTML = '<p class="text-slate-500">No symbols match your filter</p>';
        pagination.innerHTML = '';
        return;
    }

    list.innerHTML = pageSymbols.map(s => `
        <div class="p-3 bg-slate-700 rounded-lg hover:bg-slate-600 cursor-pointer flex justify-between items-start" onclick="loadSymbolDetail('${s.symbol_id || ''}', '${escapeJs(s.fqn || s.name)}')">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    ${getSymbolIcon(s.kind || 'function')}
                    <span class="font-medium text-slate-100">${escapeHtml(s.name || 'Unknown')}</span>
                    <span class="text-xs px-2 py-0.5 bg-slate-600 rounded text-slate-300">${s.kind || 'symbol'}</span>
                </div>
                <div class="text-xs text-slate-400 font-mono mt-1">${escapeHtml(s.file_path || '')}</div>
                ${s.signature ? `<code class="text-xs text-slate-500 block mt-1">${escapeHtml(s.signature)}</code>` : ''}
            </div>
            <div class="text-xs text-slate-500">
                Line ${s.start_line || '?'}
            </div>
        </div>
    `).join('');

    // Pagination
    const totalPages = Math.ceil(filteredSymbols.length / symbolsPageSize);
    pagination.innerHTML = `
        <span>Showing ${start + 1}-${Math.min(start + symbolsPageSize, filteredSymbols.length)} of ${filteredSymbols.length}</span>
        <div class="flex gap-2">
            <button onclick="symbolsPage = Math.max(0, symbolsPage - 1); renderSymbolsBrowser()" ${symbolsPage === 0 ? 'disabled' : ''} class="px-3 py-1 bg-slate-700 rounded text-sm ${symbolsPage === 0 ? 'opacity-50' : 'hover:bg-slate-600'}">Prev</button>
            <button onclick="symbolsPage = Math.min(${totalPages - 1}, symbolsPage + 1); renderSymbolsBrowser()" ${symbolsPage >= totalPages - 1 ? 'disabled' : ''} class="px-3 py-1 bg-slate-700 rounded text-sm ${symbolsPage >= totalPages - 1 ? 'opacity-50' : 'hover:bg-slate-600'}">Next</button>
        </div>
    `;
}

// ========== File Summaries ==========

async function loadFileSummaries() {
    if (!currentRepoName) return;

    const list = document.getElementById('file-summaries-list');
    list.innerHTML = '<p class="text-slate-400">Loading file summaries...</p>';

    try {
        // Get repo stats to find schema
        const repoResp = await fetch(`/api/repos/${currentRepoName}/stats`);
        const repoData = await repoResp.json();
        const schema = repoData.schema;

        if (!schema) {
            list.innerHTML = '<p class="text-slate-500">Repository schema not found</p>';
            return;
        }

        // Query file_summary table directly
        const response = await fetch(`/api/tables/${schema}/file_summary/data?limit=50`);
        const data = await response.json();

        if (data.rows && data.rows.length > 0) {
            list.innerHTML = data.rows.map(row => `
                <div class="p-4 bg-slate-700 rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-slate-100">${escapeHtml(row.file_path || 'Unknown file')}</h4>
                        <span class="text-xs text-slate-500">${row.created_at ? new Date(row.created_at).toLocaleDateString() : ''}</span>
                    </div>
                    <p class="text-sm text-slate-300">${escapeHtml(row.summary || 'No summary available')}</p>
                    ${row.purpose ? `<p class="text-xs text-slate-400 mt-2"><strong>Purpose:</strong> ${escapeHtml(row.purpose)}</p>` : ''}
                    ${row.key_exports ? `<p class="text-xs text-slate-400 mt-1"><strong>Key exports:</strong> ${escapeHtml(typeof row.key_exports === 'string' ? row.key_exports : JSON.stringify(row.key_exports))}</p>` : ''}
                </div>
            `).join('');
        } else {
            list.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-slate-500 mb-4">No file summaries generated yet</p>
                    <p class="text-sm text-slate-400">Run a SUMMARIZE_FILES job to generate AI summaries:</p>
                    <code class="text-xs bg-slate-800 px-2 py-1 rounded mt-2 inline-block text-slate-300">
                        POST /api/registry/${currentRepoName}/jobs {"job_type": "SUMMARIZE_FILES"}
                    </code>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading file summaries:', error);
        list.innerHTML = '<p class="text-red-400">Error loading file summaries</p>';
    }
}

async function showFileDetail(encodedPath) {
    const filePath = decodeURIComponent(encodedPath);

    try {
        const response = await fetch('/api/mcp/tools/read_file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                params: { repo: currentRepoName, path: filePath, start_line: 1, end_line: 100 }
            })
        });
        const data = await response.json();

        document.getElementById('repo-overview').style.display = 'none';
        document.getElementById('file-detail').style.display = 'block';
        document.getElementById('file-detail-title').textContent = filePath.split('/').pop();
        document.getElementById('file-detail-path').textContent = filePath;

        const symbolsDiv = document.getElementById('file-symbols');
        if (data.result && data.result.content) {
            symbolsDiv.innerHTML = `
                <pre class="bg-slate-900 p-4 rounded-lg text-sm text-slate-300 overflow-x-auto"><code>${escapeHtml(data.result.content)}</code></pre>
                <div class="mt-4 text-sm text-slate-400">
                    Language: ${data.result.language || 'unknown'} |
                    Lines: ${data.result.total_lines || 'unknown'}
                </div>
            `;
        } else {
            symbolsDiv.innerHTML = '<p class="text-slate-500">Could not load file content</p>';
        }
    } catch (error) {
        console.error('Error loading file:', error);
    }
}

function hideFileDetail() {
    document.getElementById('file-detail').style.display = 'none';
    document.getElementById('repo-overview').style.display = 'block';
}

async function loadSymbolDetail(symbolId, fqn) {
    if (!currentRepoName) return;

    // Build params - use symbol_id if available, otherwise fqn
    const params = { repo: currentRepoName, max_depth: 2 };
    if (symbolId) {
        params.symbol_id = symbolId;
    } else if (fqn) {
        params.fqn = fqn;
    }

    try {
        // Get callers and callees in parallel
        const [callersResp, calleesResp] = await Promise.all([
            fetch('/api/mcp/tools/callers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ params })
            }),
            fetch('/api/mcp/tools/callees', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ params })
            })
        ]);

        const callersData = await callersResp.json();
        const calleesData = await calleesResp.json();

        document.getElementById('repo-overview').style.display = 'none';
        document.getElementById('symbol-detail').style.display = 'block';
        document.getElementById('symbol-detail-name').textContent = fqn || symbolId || 'Symbol';
        document.getElementById('symbol-detail-meta').textContent = `Repository: ${currentRepoName}`;

        // Render callers (who calls this symbol)
        const callersList = document.getElementById('symbol-callers-list');
        const callers = callersData.result?.callers || [];
        if (callers.length > 0) {
            callersList.innerHTML = callers.map(c => `
                <div class="text-sm text-slate-300 px-3 py-2 bg-slate-700 rounded hover:bg-slate-600 cursor-pointer" onclick="loadSymbolDetail('${c.symbol_id || ''}', '${escapeJs(c.fqn || c.name)}')">
                    <div class="flex items-center gap-2">
                        ${getSymbolIcon(c.kind || 'function')}
                        <span class="text-blue-400 font-medium">${escapeHtml(c.name || c.fqn || 'Unknown')}</span>
                        <span class="text-xs text-slate-500">${c.kind || ''}</span>
                    </div>
                    <div class="text-xs text-slate-500 mt-1">${escapeHtml(c.file_path || '')}${c.line ? `:${c.line}` : ''}</div>
                </div>
            `).join('');
        } else {
            callersList.innerHTML = '<p class="text-sm text-slate-500">No callers found - this symbol is not called by others</p>';
        }

        // Render callees (what this symbol calls)
        const calleesList = document.getElementById('symbol-callees-list');
        const callees = calleesData.result?.callees || [];
        if (callees.length > 0) {
            calleesList.innerHTML = callees.map(c => `
                <div class="text-sm text-slate-300 px-3 py-2 bg-slate-700 rounded hover:bg-slate-600 cursor-pointer" onclick="loadSymbolDetail('${c.symbol_id || ''}', '${escapeJs(c.fqn || c.name)}')">
                    <div class="flex items-center gap-2">
                        ${getSymbolIcon(c.kind || 'function')}
                        <span class="text-green-400 font-medium">${escapeHtml(c.name || c.fqn || 'Unknown')}</span>
                        <span class="text-xs text-slate-500">${c.kind || ''}</span>
                    </div>
                    <div class="text-xs text-slate-500 mt-1">${escapeHtml(c.file_path || '')}${c.line ? `:${c.line}` : ''}</div>
                </div>
            `).join('');
        } else {
            calleesList.innerHTML = '<p class="text-sm text-slate-500">No callees found - this symbol doesn\'t call other functions</p>';
        }

        // Show error messages if any
        if (callersData.result?.error) {
            callersList.innerHTML = `<p class="text-sm text-red-400">${escapeHtml(callersData.result.error)}</p>`;
        }
        if (calleesData.result?.error) {
            calleesList.innerHTML = `<p class="text-sm text-red-400">${escapeHtml(calleesData.result.error)}</p>`;
        }

    } catch (error) {
        console.error('Error loading symbol detail:', error);
        document.getElementById('symbol-callers-list').innerHTML = `<p class="text-sm text-red-400">Error: ${error.message}</p>`;
    }
}

function hideSymbolDetail() {
    document.getElementById('symbol-detail').style.display = 'none';
    document.getElementById('repo-overview').style.display = 'block';
}

// ========== Database Table View ==========

async function loadSchemas() {
    const response = await fetch('/api/schemas');
    const data = await response.json();

    const select = document.getElementById('schema-select');
    data.schemas.forEach(schema => {
        const option = document.createElement('option');
        option.value = schema;
        option.textContent = schema;
        select.appendChild(option);
    });
}

async function loadTables(schema) {
    if (!schema) return;
    currentSchema = schema;

    const response = await fetch(`/api/schemas/${schema}/tables`);
    const data = await response.json();

    const list = document.getElementById('table-list');
    list.innerHTML = `<h3 class="text-sm font-semibold text-slate-300 mb-2">Tables (${data.tables.length})</h3>`;

    data.tables.forEach(table => {
        const button = document.createElement('button');
        button.className = 'w-full text-left px-3 py-2 text-sm rounded hover:bg-slate-700 text-slate-300 flex justify-between items-center';
        button.innerHTML = `
            <span>${table.name}</span>
            <span class="text-xs text-slate-500">${table.row_count}</span>
        `;
        button.onclick = () => loadTableData(schema, table.name);
        list.appendChild(button);
    });
}

async function loadTableData(schema, table, page = 0) {
    currentTable = table;
    currentPage = page;

    const offset = page * pageSize;
    const response = await fetch(`/api/tables/${schema}/${table}/data?offset=${offset}&limit=${pageSize}`);
    const data = await response.json();

    // Update UI
    document.getElementById('table-empty-state').style.display = 'none';
    document.getElementById('table-view-content').style.display = 'block';
    document.getElementById('table-title').textContent = table;
    document.getElementById('table-info').textContent = `${data.total} rows total`;

    // Render table
    const thead = document.getElementById('table-header');
    const tbody = document.getElementById('table-body');

    if (data.rows.length > 0) {
        currentRows = data.rows;
        const columns = Object.keys(data.rows[0]);

        thead.innerHTML = columns.map(col =>
            `<th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">${col}</th>`
        ).join('');

        tbody.innerHTML = data.rows.map((row, index) =>
            `<tr class="hover:bg-slate-700/50 cursor-pointer" onclick="showRowDetail(${index})">
                ${columns.map(col => {
                    let value = row[col];
                    if (value === null) value = '<span class="text-slate-500 italic">null</span>';
                    else if (typeof value === 'object') value = JSON.stringify(value);
                    else if (typeof value === 'string' && value.length > 100) value = escapeHtml(value.substring(0, 100)) + '...';
                    else value = escapeHtml(String(value));

                    return `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">${value}</td>`;
                }).join('')}
            </tr>`
        ).join('');
    }

    // Pagination
    document.getElementById('pagination-info').textContent =
        `Showing ${offset + 1}-${Math.min(offset + pageSize, data.total)} of ${data.total}`;

    const controls = document.getElementById('pagination-controls');
    controls.innerHTML = `
        <button
            onclick="loadTableData('${schema}', '${table}', ${page - 1})"
            ${page === 0 ? 'disabled' : ''}
            class="px-3 py-1 bg-slate-700 rounded text-sm text-slate-300 ${page === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'}"
        >
            Previous
        </button>
        <button
            onclick="loadTableData('${schema}', '${table}', ${page + 1})"
            ${!data.has_more ? 'disabled' : ''}
            class="px-3 py-1 bg-slate-700 rounded text-sm text-slate-300 ${!data.has_more ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'}"
        >
            Next
        </button>
    `;
}

function exportCSV() {
    alert('CSV export coming soon!');
}

function showRowDetail(rowIndex) {
    const row = currentRows[rowIndex];
    if (!row) return;

    const modal = document.getElementById('row-detail-modal');
    const content = document.getElementById('detail-content');
    const title = document.getElementById('detail-title');

    title.textContent = `${currentTable} - Row ${rowIndex + 1}`;

    let html = '<div class="space-y-4">';
    for (const [key, value] of Object.entries(row)) {
        html += `
            <div class="border-b border-slate-700 pb-3">
                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wide mb-1">${key}</label>
                <div class="text-sm text-slate-200">
                    ${formatDetailValue(value)}
                </div>
            </div>
        `;
    }
    html += '</div>';
    content.innerHTML = html;

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function formatDetailValue(value) {
    if (value === null) {
        return '<span class="text-slate-500 italic">null</span>';
    }
    if (typeof value === 'object') {
        return `<pre class="bg-slate-900 p-2 rounded text-xs overflow-x-auto whitespace-pre-wrap text-slate-300">${JSON.stringify(value, null, 2)}</pre>`;
    }
    if (typeof value === 'string' && value.length > 200) {
        return `<pre class="bg-slate-900 p-2 rounded text-sm max-h-64 overflow-y-auto whitespace-pre-wrap text-slate-300">${escapeHtml(value)}</pre>`;
    }
    if (typeof value === 'string' && value.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
        return `<code class="bg-slate-900 px-1 rounded text-sm text-slate-300">${value}</code>`;
    }
    return escapeHtml(String(value));
}

function closeRowDetail() {
    const modal = document.getElementById('row-detail-modal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

// Utilities
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

function escapeJs(text) {
    if (text === null || text === undefined) return '';
    return String(text).replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// Close modal with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeRowDetail();
});
</script>
{% endblock %}
