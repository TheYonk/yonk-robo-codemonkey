{% extends "base.html" %}

{% block title %}MCP Tool Tester - RoboMonkey{% endblock %}

{% block content %}
<!-- Quick Ask Section - Prominent at top -->
<div class="bg-gradient-to-r from-blue-900/50 to-purple-900/50 border border-blue-700/50 shadow-lg rounded-lg p-6 mb-6">
    <h2 class="text-xl font-bold text-slate-100 mb-4">Quick Ask</h2>
    <p class="text-slate-400 text-sm mb-4">Ask a question about your codebase and get AI-powered results</p>
    <div class="flex gap-4 items-end">
        <div class="flex-1">
            <label for="quick-ask-question" class="block text-sm font-medium text-slate-300 mb-2">Question</label>
            <textarea
                id="quick-ask-question"
                rows="2"
                placeholder="e.g., How does authentication work? Where are database queries handled?"
                class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 resize-none"
            ></textarea>
        </div>
        <div class="w-48">
            <label for="quick-ask-repo" class="block text-sm font-medium text-slate-300 mb-2">Repository</label>
            <select
                id="quick-ask-repo"
                data-repo-selector
                class="w-full px-3 py-3 bg-slate-800 border border-slate-600 rounded-lg text-slate-100 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500"
            >
                <option value="">Loading repos...</option>
            </select>
        </div>
        <button
            onclick="executeQuickAsk()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            Ask
        </button>
    </div>
    <!-- Quick Ask Loading/Results inline -->
    <div id="quick-ask-loading" class="hidden mt-4 text-center py-4">
        <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
        <span class="ml-2 text-slate-400">Searching codebase...</span>
    </div>
</div>

<div class="grid grid-cols-12 gap-6">
    <!-- Tool List Sidebar -->
    <div class="col-span-3">
        <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-4">
            <h2 class="text-lg font-semibold text-slate-100 mb-4">MCP Tools</h2>
            <div class="mb-4">
                <input
                    type="text"
                    id="tool-search"
                    placeholder="Search tools..."
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500"
                    oninput="filterTools(this.value)"
                >
            </div>
            <div id="tool-categories" class="space-y-4 overflow-y-auto" style="max-height: calc(100vh - 400px);">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Tool Form and Results -->
    <div class="col-span-9">
        <!-- Tool Info -->
        <div class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6 mb-6">
            <div id="tool-header">
                <h2 class="text-2xl font-bold text-slate-400">Select a tool from the sidebar</h2>
                <p class="text-slate-500 mt-2">Or use Quick Ask above for simple questions</p>
            </div>
        </div>

        <!-- Tool Form -->
        <div id="tool-form-container" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6 mb-6" style="display: none;">
            <h3 class="text-lg font-semibold text-slate-100 mb-4">Parameters</h3>
            <form id="tool-form" class="space-y-4">
                <!-- Dynamically populated -->
            </form>
            <div class="mt-6 flex gap-3">
                <button
                    onclick="executeTool()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                >
                    Run Tool
                </button>
                <button
                    onclick="clearForm()"
                    type="button"
                    class="bg-slate-700 text-slate-300 px-6 py-2 rounded-md hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-500/50"
                >
                    Clear
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="results-container" class="bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-slate-100">Results</h3>
                <div class="flex gap-2">
                    <span id="execution-time" class="text-sm text-slate-400"></span>
                    <button onclick="copyResults()" class="text-sm text-blue-400 hover:text-blue-300">
                        Copy JSON
                    </button>
                </div>
            </div>
            <div id="results-status" class="mb-3"></div>

            <!-- View Tabs -->
            <div class="border-b border-slate-700 mb-4">
                <nav class="flex -mb-px">
                    <button
                        id="tab-formatted"
                        onclick="switchTab('formatted')"
                        class="tab-button border-b-2 border-blue-500 text-blue-400 px-4 py-2 font-medium text-sm"
                    >
                        Formatted
                    </button>
                    <button
                        id="tab-json"
                        onclick="switchTab('json')"
                        class="tab-button border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-500 px-4 py-2 font-medium text-sm"
                    >
                        { } Raw JSON
                    </button>
                </nav>
            </div>

            <!-- Formatted View -->
            <div id="view-formatted" class="formatted-view">
                <!-- Populated by JavaScript -->
            </div>

            <!-- JSON View -->
            <pre id="results-json" class="json-view" style="display: none;"></pre>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden bg-slate-800 border border-slate-700 shadow-lg rounded-lg p-6 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-slate-400">Executing tool...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTool = null;
let allTools = [];
let reposList = [];
let tagsList = [];

// Load tools, repos, and tags on page load
document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([
        loadTools(),
        loadRepos(),
        loadTags()
    ]);

    // Listen for default repo changes from the status bar
    window.addEventListener('defaultRepoChanged', function(e) {
        const newRepo = e.detail?.repo;
        if (newRepo) {
            const quickAskRepo = document.getElementById('quick-ask-repo');
            if (quickAskRepo && quickAskRepo.querySelector(`option[value="${newRepo}"]`)) {
                quickAskRepo.value = newRepo;
            }
        }
    });
});

// Quick Ask functionality
async function executeQuickAsk() {
    const question = document.getElementById('quick-ask-question').value.trim();
    const repo = document.getElementById('quick-ask-repo').value;

    if (!question) {
        alert('Please enter a question');
        return;
    }
    if (!repo) {
        alert('Please select a repository');
        return;
    }

    // Show loading
    document.getElementById('quick-ask-loading').classList.remove('hidden');

    try {
        const response = await fetch('/api/mcp/tools/ask_codebase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                params: {
                    question: question,
                    repo: repo,
                    top_docs: 5,
                    top_code: 10,
                    top_symbols: 10
                }
            })
        });

        const result = await response.json();

        // Display results in the main results area
        currentTool = 'ask_codebase';
        displayResults(result);

        // Scroll to results
        document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        displayResults({
            error: error.message,
            success: false
        });
    } finally {
        document.getElementById('quick-ask-loading').classList.add('hidden');
    }
}

// Load repos for dropdowns
async function loadRepos() {
    try {
        const response = await fetch('/api/repos');
        const data = await response.json();
        reposList = data.repositories || [];

        // Populate Quick Ask dropdown
        const quickAskRepo = document.getElementById('quick-ask-repo');
        quickAskRepo.innerHTML = '<option value="">Select repository...</option>';
        reposList.forEach(repo => {
            const option = document.createElement('option');
            option.value = repo.name;
            option.textContent = `${repo.name} (${repo.stats?.files || 0} files)`;
            quickAskRepo.appendChild(option);
        });

        // Apply default repo if available
        const defaultRepo = typeof getDefaultRepo === 'function' ? getDefaultRepo() : '';
        if (defaultRepo && quickAskRepo.querySelector(`option[value="${defaultRepo}"]`)) {
            quickAskRepo.value = defaultRepo;
        } else if (reposList.length === 1) {
            // Auto-select if only one repo
            quickAskRepo.value = reposList[0].name;
        }
    } catch (error) {
        console.error('Error loading repos:', error);
        document.getElementById('quick-ask-repo').innerHTML = '<option value="">Error loading repos</option>';
    }
}

// Load tags for dropdowns
async function loadTags() {
    try {
        const response = await fetch('/api/mcp/tools/list_tags', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ params: {} })
        });
        const data = await response.json();
        tagsList = data.result?.tags || [];
    } catch (error) {
        console.error('Error loading tags:', error);
    }
}

// Handle Enter key in Quick Ask textarea
document.addEventListener('DOMContentLoaded', () => {
    const quickAskInput = document.getElementById('quick-ask-question');
    if (quickAskInput) {
        quickAskInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                executeQuickAsk();
            }
        });
    }
});

async function loadTools() {
    try {
        const response = await fetch('/api/mcp/tools');
        const data = await response.json();
        allTools = data.tools;

        renderToolCategories(data.categorized);
    } catch (error) {
        console.error('Error loading tools:', error);
        alert('Failed to load tools: ' + error.message);
    }
}

function renderToolCategories(categorized) {
    const container = document.getElementById('tool-categories');
    container.innerHTML = '';

    for (const [category, tools] of Object.entries(categorized)) {
        const categoryDiv = document.createElement('div');
        categoryDiv.innerHTML = `
            <h3 class="text-sm font-semibold text-slate-300 mb-2">${category}</h3>
            <div class="space-y-1">
                ${tools.map(tool => `
                    <button
                        onclick="selectTool('${tool.name}')"
                        class="tool-item w-full text-left px-3 py-2 text-sm rounded hover:bg-slate-700 text-slate-300 transition"
                        data-tool="${tool.name}"
                        data-description="${tool.description.toLowerCase()}"
                    >
                        ${tool.name}
                    </button>
                `).join('')}
            </div>
        `;
        container.appendChild(categoryDiv);
    }
}

function filterTools(query) {
    const lowerQuery = query.toLowerCase();
    const toolItems = document.querySelectorAll('.tool-item');

    toolItems.forEach(item => {
        const name = item.getAttribute('data-tool').toLowerCase();
        const desc = item.getAttribute('data-description');
        const matches = name.includes(lowerQuery) || desc.includes(lowerQuery);
        item.style.display = matches ? 'block' : 'none';
    });
}

async function selectTool(toolName) {
    currentTool = toolName;

    // Highlight selected tool
    document.querySelectorAll('.tool-item').forEach(item => {
        item.classList.remove('bg-blue-900/50', 'text-blue-400', 'border', 'border-blue-700');
        if (item.getAttribute('data-tool') === toolName) {
            item.classList.add('bg-blue-900/50', 'text-blue-400', 'border', 'border-blue-700');
        }
    });

    // Load tool schema
    try {
        const response = await fetch(`/api/mcp/tools/${toolName}/schema`);
        const schema = await response.json();

        renderToolForm(schema);
    } catch (error) {
        console.error('Error loading tool schema:', error);
        alert('Failed to load tool schema: ' + error.message);
    }
}

function renderToolForm(schema) {
    // Update header
    document.getElementById('tool-header').innerHTML = `
        <h2 class="text-2xl font-bold text-slate-100">${schema.name}</h2>
        <p class="text-slate-400 mt-2">${schema.description}</p>
    `;

    // Build form
    const form = document.getElementById('tool-form');
    form.innerHTML = '';

    schema.parameters.forEach(param => {
        const fieldDiv = document.createElement('div');
        const inputId = `param-${param.name}`;

        let inputHtml = '';

        // Special handling for repo parameter - use dropdown
        if (param.name === 'repo' || param.name === 'repo_name' || param.name === 'repo_id') {
            inputHtml = buildRepoDropdown(inputId, param.name, param.required, param.default);
        }
        // Special handling for tags parameters - use multi-select or checkbox list
        else if (param.name === 'tags_any' || param.name === 'tags_all' || param.name === 'tags') {
            inputHtml = buildTagsSelector(inputId, param.name, param.description);
        }
        // Special handling for language parameter - use dropdown
        else if (param.name === 'language' || param.name === 'languages') {
            inputHtml = buildLanguageDropdown(inputId, param.name, param.required, param.type.includes('list'));
        }
        else if (param.type === 'bool' || param.type === 'boolean') {
            inputHtml = `
                <input
                    type="checkbox"
                    id="${inputId}"
                    name="${param.name}"
                    ${param.default ? 'checked' : ''}
                    class="rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-blue-500/50"
                >
            `;
        } else if (param.type === 'int' || param.type === 'integer') {
            inputHtml = `
                <input
                    type="number"
                    id="${inputId}"
                    name="${param.name}"
                    ${param.default !== null ? `value="${param.default}"` : ''}
                    ${param.required ? 'required' : ''}
                    class="mt-1 block w-full rounded-md bg-slate-700 border-slate-600 text-slate-100 shadow-sm focus:border-blue-500 focus:ring-blue-500/50 sm:text-sm"
                >
            `;
        } else {
            // Text input for strings and others
            inputHtml = `
                <input
                    type="text"
                    id="${inputId}"
                    name="${param.name}"
                    ${param.default !== null ? `value="${param.default}"` : ''}
                    ${param.required ? 'required' : ''}
                    class="mt-1 block w-full rounded-md bg-slate-700 border-slate-600 text-slate-100 placeholder-slate-500 shadow-sm focus:border-blue-500 focus:ring-blue-500/50 sm:text-sm"
                    placeholder="${param.description || ''}"
                >
            `;
        }

        fieldDiv.innerHTML = `
            <label for="${inputId}" class="block text-sm font-medium text-slate-300">
                ${param.name}
                ${param.required ? '<span class="text-red-400">*</span>' : '<span class="text-slate-500">(optional)</span>'}
                <span class="text-slate-500 font-normal">${param.type}</span>
            </label>
            ${inputHtml}
            ${param.description ? `<p class="mt-1 text-xs text-slate-500">${param.description}</p>` : ''}
        `;

        form.appendChild(fieldDiv);
    });

    // Show form
    document.getElementById('tool-form-container').style.display = 'block';
    document.getElementById('results-container').style.display = 'none';
}

// Build repo dropdown
function buildRepoDropdown(inputId, paramName, required, defaultValue) {
    let options = '<option value="">Select repository...</option>';
    reposList.forEach(repo => {
        const selected = (defaultValue === repo.name) ? 'selected' : '';
        options += `<option value="${repo.name}" ${selected}>${repo.name} (${repo.stats?.files || 0} files)</option>`;
    });

    // Auto-select first repo if required and only one exists
    if (required && reposList.length === 1) {
        options = `<option value="${reposList[0].name}" selected>${reposList[0].name}</option>`;
    }

    return `
        <select
            id="${inputId}"
            name="${paramName}"
            ${required ? 'required' : ''}
            class="mt-1 block w-full rounded-md bg-slate-700 border-slate-600 text-slate-100 shadow-sm focus:border-blue-500 focus:ring-blue-500/50 sm:text-sm"
        >
            ${options}
        </select>
    `;
}

// Build tags selector (checkboxes for multiple selection)
function buildTagsSelector(inputId, paramName, description) {
    if (tagsList.length === 0) {
        return `
            <input
                type="text"
                id="${inputId}"
                name="${paramName}"
                placeholder="No tags available - enter comma-separated tags"
                class="mt-1 block w-full rounded-md bg-slate-700 border-slate-600 text-slate-100 placeholder-slate-500 shadow-sm focus:border-blue-500 focus:ring-blue-500/50 sm:text-sm"
            >
        `;
    }

    let checkboxes = '<div class="mt-2 flex flex-wrap gap-2">';
    tagsList.forEach(tag => {
        checkboxes += `
            <label class="inline-flex items-center px-2 py-1 bg-slate-700 rounded border border-slate-600 hover:border-blue-500 cursor-pointer">
                <input type="checkbox" name="${paramName}" value="${tag.name}" class="rounded bg-slate-600 border-slate-500 text-blue-600 mr-2">
                <span class="text-sm text-slate-300">${tag.name}</span>
            </label>
        `;
    });
    checkboxes += '</div>';

    return checkboxes;
}

// Build language dropdown
function buildLanguageDropdown(inputId, paramName, required, isMultiple) {
    const languages = ['python', 'javascript', 'typescript', 'go', 'java', 'c', 'rust', 'sql', 'markdown', 'yaml', 'json'];

    if (isMultiple) {
        let checkboxes = '<div class="mt-2 flex flex-wrap gap-2">';
        languages.forEach(lang => {
            checkboxes += `
                <label class="inline-flex items-center px-2 py-1 bg-slate-700 rounded border border-slate-600 hover:border-blue-500 cursor-pointer">
                    <input type="checkbox" name="${paramName}" value="${lang}" class="rounded bg-slate-600 border-slate-500 text-blue-600 mr-2">
                    <span class="text-sm text-slate-300">${lang}</span>
                </label>
            `;
        });
        checkboxes += '</div>';
        return checkboxes;
    }

    let options = '<option value="">Any language</option>';
    languages.forEach(lang => {
        options += `<option value="${lang}">${lang}</option>`;
    });

    return `
        <select
            id="${inputId}"
            name="${paramName}"
            ${required ? 'required' : ''}
            class="mt-1 block w-full rounded-md bg-slate-700 border-slate-600 text-slate-100 shadow-sm focus:border-blue-500 focus:ring-blue-500/50 sm:text-sm"
        >
            ${options}
        </select>
    `;
}

async function executeTool() {
    if (!currentTool) return;

    // Collect form data
    const form = document.getElementById('tool-form');
    const params = {};

    // Handle all inputs, including multi-checkbox for tags/languages
    const allInputs = form.querySelectorAll('input, select, textarea');
    const multiValueParams = new Set(['tags_any', 'tags_all', 'tags', 'languages']);

    allInputs.forEach(input => {
        const name = input.name;
        if (!name) return;

        if (input.type === 'checkbox') {
            if (multiValueParams.has(name)) {
                // Multi-checkbox: collect checked values into array
                if (input.checked) {
                    if (!params[name]) params[name] = [];
                    params[name].push(input.value);
                }
            } else {
                // Single checkbox: boolean
                params[name] = input.checked;
            }
        } else if (input.type === 'number') {
            if (input.value) params[name] = parseFloat(input.value);
        } else if (input.tagName === 'SELECT') {
            if (input.value) params[name] = input.value;
        } else {
            if (input.value) params[name] = input.value;
        }
    });

    // Show loading
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('results-container').style.display = 'none';

    try {
        const response = await fetch(`/api/mcp/tools/${currentTool}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ params })
        });

        const result = await response.json();

        // Display results
        displayResults(result);
    } catch (error) {
        displayResults({
            error: error.message,
            success: false
        });
    } finally {
        document.getElementById('loading').classList.add('hidden');
    }
}

function switchTab(tab) {
    // Update tab buttons
    document.getElementById('tab-formatted').className = tab === 'formatted'
        ? 'tab-button border-b-2 border-blue-500 text-blue-400 px-4 py-2 font-medium text-sm'
        : 'tab-button border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-500 px-4 py-2 font-medium text-sm';

    document.getElementById('tab-json').className = tab === 'json'
        ? 'tab-button border-b-2 border-blue-500 text-blue-400 px-4 py-2 font-medium text-sm'
        : 'tab-button border-b-2 border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-500 px-4 py-2 font-medium text-sm';

    // Show/hide views
    document.getElementById('view-formatted').style.display = tab === 'formatted' ? 'block' : 'none';
    document.getElementById('results-json').style.display = tab === 'json' ? 'block' : 'none';
}

function displayResults(result) {
    document.getElementById('results-container').style.display = 'block';

    // Show execution time
    if (result.execution_time_ms) {
        document.getElementById('execution-time').textContent = `${result.execution_time_ms}ms`;
    }

    // Show status
    const statusDiv = document.getElementById('results-status');
    if (result.success) {
        statusDiv.innerHTML = '<div class="bg-emerald-900/30 border border-emerald-700 text-emerald-400 px-4 py-2 rounded">Success</div>';
    } else {
        statusDiv.innerHTML = '<div class="bg-red-900/30 border border-red-700 text-red-400 px-4 py-2 rounded">Error</div>';
    }

    // Format and display JSON
    const jsonView = document.getElementById('results-json');
    jsonView.textContent = JSON.stringify(result, null, 2);

    // Generate formatted view
    const formattedView = document.getElementById('view-formatted');
    formattedView.innerHTML = formatToolResult(currentTool, result);

    // Show formatted view by default
    switchTab('formatted');
}

function formatToolResult(toolName, result) {
    // Handle errors
    if (!result.success || result.error) {
        return `
            <div class="bg-red-900/30 border border-red-700 rounded-lg p-4">
                <h4 class="font-semibold text-red-400 mb-2">Error</h4>
                <p class="text-red-400">${result.error || 'Unknown error'}</p>
                ${result.error_type ? `<p class="text-sm text-red-500 mt-2">Type: ${result.error_type}</p>` : ''}
            </div>
        `;
    }

    // Special formatting for ask_codebase tool
    if (toolName === 'ask_codebase' && result.result) {
        return formatAskCodebaseResult(result.result);
    }

    // Default formatting for other tools
    return formatGenericResult(result.result);
}

function formatAskCodebaseResult(data) {
    let html = '';

    // Header
    html += `
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-slate-100 mb-2">${escapeHtml(data.question || 'Question')}</h2>
            <div class="flex gap-4 text-sm text-slate-400">
                <span><strong class="text-slate-300">Repository:</strong> ${escapeHtml(data.repo_name || 'N/A')}</span>
                <span><strong class="text-slate-300">Total Results:</strong> ${data.total_results_found || 0}</span>
            </div>
            ${data.search_strategies_used && data.search_strategies_used.length > 0
                ? `<div class="mt-2 text-sm text-slate-400"><strong class="text-slate-300">Strategies:</strong> ${data.search_strategies_used.join(', ')}</div>`
                : ''}
        </div>
    `;

    // Summary
    if (data.summary) {
        html += `
            <div class="mb-6 bg-blue-900/30 border border-blue-700 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-blue-400 mb-2">Summary</h3>
                <p class="text-slate-300">${escapeHtml(data.summary)}</p>
            </div>
        `;
    }

    // Documentation
    if (data.documentation && data.documentation.length > 0) {
        html += formatSection('Documentation', data.documentation, (doc, i) => {
            const docId = `doc-${i}`;
            const content = doc.summary || doc.content || '';
            const isLong = content.length > 300;
            const preview = isLong ? content.substring(0, 300) + '...' : content;

            // Handle both API field names (file/relevance) and legacy names (file_path/relevance_score)
            const filePath = doc.file || doc.file_path || 'N/A';
            const relevance = doc.relevance ?? doc.relevance_score ?? 0;

            return `
                <div class="mb-4 p-4 bg-slate-700/50 rounded-lg border border-slate-600">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg text-slate-100">${escapeHtml(doc.title || 'Untitled')}</h4>
                            <div class="text-sm text-slate-400 mt-1">
                                <span class="font-mono bg-slate-800 px-2 py-0.5 rounded text-slate-300">${escapeHtml(filePath)}</span>
                                <span class="ml-3 font-semibold text-amber-400">${relevance.toFixed(3)}</span>
                            </div>
                        </div>
                        ${isLong ? `
                            <button
                                onclick="toggleExpand('${docId}')"
                                class="ml-2 text-blue-400 hover:text-blue-300 text-sm font-medium"
                                id="${docId}-btn"
                            >
                                Expand
                            </button>
                        ` : ''}
                    </div>
                    <div class="mt-3 text-slate-300">
                        <div id="${docId}-preview" ${!isLong ? '' : ''}>
                            ${escapeHtml(preview)}
                        </div>
                        ${isLong ? `
                            <div id="${docId}-full" style="display: none;">
                                ${escapeHtml(content)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
    }

    // Code Files
    if (data.code_files && data.code_files.length > 0) {
        html += formatSection('Code Files', data.code_files, (code, i) => {
            const codeId = `code-${i}`;
            const snippet = code.snippet || '';
            const isLong = snippet.split('\n').length > 15;
            const previewLines = isLong ? snippet.split('\n').slice(0, 15).join('\n') + '\n...' : snippet;

            // Handle both API field names (file/lines/relevance) and legacy names (file_path/line_range/relevance_score)
            const filePath = code.file || code.file_path || 'Unknown';
            const lines = code.lines || (code.line_range ? code.line_range.join('-') : 'N/A');
            const relevance = code.relevance ?? code.relevance_score ?? 0;

            return `
                <div class="mb-4 p-4 bg-slate-700/50 rounded-lg border border-slate-600">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-lg text-slate-100">
                                <span class="font-mono bg-blue-900/50 px-2 py-0.5 rounded text-blue-400">
                                    ${escapeHtml(filePath)}
                                </span>
                            </h4>
                            <div class="text-sm text-slate-400 mt-2">
                                <span class="bg-slate-800 px-2 py-0.5 rounded text-slate-300">Lines ${escapeHtml(lines)}</span>
                                <span class="ml-2 bg-slate-800 px-2 py-0.5 rounded text-slate-300">${escapeHtml(code.language || 'unknown')}</span>
                                <span class="ml-2 font-semibold text-amber-400">${relevance.toFixed(3)}</span>
                            </div>
                            ${code.context ? `<p class="text-sm text-slate-400 mt-2 italic">${escapeHtml(code.context)}</p>` : ''}
                        </div>
                        ${isLong && snippet ? `
                            <button
                                onclick="toggleExpand('${codeId}')"
                                class="ml-2 text-blue-400 hover:text-blue-300 text-sm font-medium whitespace-nowrap"
                                id="${codeId}-btn"
                            >
                                Expand
                            </button>
                        ` : ''}
                    </div>
                    ${snippet ? `
                        <div id="${codeId}-preview" class="mt-3">
                            <pre class="p-3 bg-slate-900 text-slate-300 rounded overflow-x-auto text-xs"><code>${escapeHtml(previewLines)}</code></pre>
                        </div>
                        ${isLong ? `
                            <div id="${codeId}-full" style="display: none;" class="mt-3">
                                <pre class="p-3 bg-slate-900 text-slate-300 rounded overflow-x-auto text-xs"><code>${escapeHtml(snippet)}</code></pre>
                            </div>
                        ` : ''}
                    ` : ''}
                </div>
            `;
        });
    }

    // Symbols
    if (data.symbols && data.symbols.length > 0) {
        html += formatSection('Key Symbols', data.symbols, sym => {
            // Handle both API field names and legacy names
            const filePath = sym.file || sym.file_path || 'N/A';
            const relevance = sym.relevance ?? sym.relevance_score ?? 0;

            return `
                <div class="mb-3 p-3 bg-slate-700/50 rounded-lg">
                    <h4 class="font-semibold text-slate-100">${escapeHtml(sym.name || 'Unknown')}</h4>
                    <div class="text-sm text-slate-400 mt-1">
                        <span>${escapeHtml(sym.kind || 'symbol')}</span>
                        <span class="ml-3">${escapeHtml(filePath)}:${sym.line || '?'}</span>
                        <span class="ml-3 text-amber-400">${relevance.toFixed(2)}</span>
                    </div>
                    ${sym.signature ? `<code class="text-sm text-slate-300 mt-1 block">${escapeHtml(sym.signature)}</code>` : ''}
                    ${sym.description ? `<p class="text-sm text-slate-400 mt-1">${escapeHtml(sym.description)}</p>` : ''}
                </div>
            `;
        });
    }

    // File Summaries
    if (data.file_summaries && data.file_summaries.length > 0) {
        html += formatSection('File Summaries', data.file_summaries, (fs, i) => {
            const fsId = `fs-${i}`;
            const summary = fs.summary || '';
            const isLong = summary.length > 200;
            const preview = isLong ? summary.substring(0, 200) + '...' : summary;

            // Handle both API field names and legacy names
            const name = fs.file || fs.name || 'Unknown';
            const relevance = fs.relevance ?? fs.relevance_score ?? 0;

            return `
                <div class="mb-4 p-4 bg-emerald-900/30 rounded-lg border border-emerald-700">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-emerald-400">
                                <span class="font-mono bg-emerald-900/50 px-2 py-0.5 rounded">
                                    ${escapeHtml(name)}
                                </span>
                            </h4>
                            <div class="text-sm text-emerald-400 mt-1 font-semibold">${relevance.toFixed(3)}</div>
                        </div>
                        ${isLong ? `
                            <button
                                onclick="toggleExpand('${fsId}')"
                                class="ml-2 text-emerald-400 hover:text-emerald-300 text-sm font-medium"
                                id="${fsId}-btn"
                            >
                                Expand
                            </button>
                        ` : ''}
                    </div>
                    <div id="${fsId}-preview" class="mt-2 text-slate-300">
                        ${escapeHtml(preview)}
                    </div>
                    ${isLong ? `
                        <div id="${fsId}-full" style="display: none;" class="mt-2 text-slate-300">
                            ${escapeHtml(summary)}
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }

    // Module Summaries
    if (data.module_summaries && data.module_summaries.length > 0) {
        html += formatSection('Module Summaries', data.module_summaries, (ms, i) => {
            const msId = `ms-${i}`;
            const summary = ms.summary || '';
            const isLong = summary.length > 200;
            const preview = isLong ? summary.substring(0, 200) + '...' : summary;

            // Handle both API field names and legacy names
            const name = ms.module || ms.name || 'Unknown';
            const relevance = ms.relevance ?? ms.relevance_score ?? 0;

            return `
                <div class="mb-4 p-4 bg-purple-900/30 rounded-lg border border-purple-700">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-purple-400">
                                <span class="font-mono bg-purple-900/50 px-2 py-0.5 rounded">
                                    ${escapeHtml(name)}
                                </span>
                            </h4>
                            <div class="text-sm text-purple-400 mt-1 font-semibold">${relevance.toFixed(3)}</div>
                        </div>
                        ${isLong ? `
                            <button
                                onclick="toggleExpand('${msId}')"
                                class="ml-2 text-purple-400 hover:text-purple-300 text-sm font-medium"
                                id="${msId}-btn"
                            >
                                Expand
                            </button>
                        ` : ''}
                    </div>
                    <div id="${msId}-preview" class="mt-2 text-slate-300">
                        ${escapeHtml(preview)}
                    </div>
                    ${isLong ? `
                        <div id="${msId}-full" style="display: none;" class="mt-2 text-slate-300">
                            ${escapeHtml(summary)}
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }

    // Symbol Summaries
    if (data.symbol_summaries && data.symbol_summaries.length > 0) {
        html += formatSection('Symbol Summaries', data.symbol_summaries, (ss, i) => {
            const ssId = `ss-${i}`;
            const summary = ss.summary || '';
            const isLong = summary.length > 200;
            const preview = isLong ? summary.substring(0, 200) + '...' : summary;

            // Handle both API field names and legacy names
            const name = ss.symbol || ss.name || 'Unknown';
            const filePath = ss.file || ss.file_path || '';
            const relevance = ss.relevance ?? ss.relevance_score ?? 0;

            return `
                <div class="mb-4 p-4 bg-amber-900/30 rounded-lg border border-amber-700">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-amber-400">
                                <span class="font-mono bg-amber-900/50 px-2 py-0.5 rounded">
                                    ${escapeHtml(name)}
                                </span>
                            </h4>
                            <div class="text-sm text-amber-400 mt-1">
                                ${filePath ? `<span class="font-mono bg-amber-900/50 px-2 py-0.5 rounded">${escapeHtml(filePath)}</span>` : ''}
                                ${ss.summary_type ? `<span class="ml-2 bg-amber-900/50 px-2 py-0.5 rounded">${escapeHtml(ss.summary_type)}</span>` : ''}
                                <span class="ml-2 font-semibold">${relevance.toFixed(3)}</span>
                            </div>
                        </div>
                        ${isLong ? `
                            <button
                                onclick="toggleExpand('${ssId}')"
                                class="ml-2 text-amber-400 hover:text-amber-300 text-sm font-medium"
                                id="${ssId}-btn"
                            >
                                Expand
                            </button>
                        ` : ''}
                    </div>
                    <div id="${ssId}-preview" class="mt-2 text-slate-300">
                        ${escapeHtml(preview)}
                    </div>
                    ${isLong ? `
                        <div id="${ssId}-full" style="display: none;" class="mt-2 text-slate-300">
                            ${escapeHtml(summary)}
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }

    // Key Files
    if (data.key_files && data.key_files.length > 0) {
        html += `
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-slate-100 mb-3">Key Files to Examine</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-slate-300">
                    ${data.key_files.map(file => `<li><code class="bg-slate-800 px-1 rounded">${escapeHtml(file)}</code></li>`).join('')}
                </ul>
            </div>
        `;
    }

    // Suggested Actions
    if (data.suggested_actions && data.suggested_actions.length > 0) {
        html += `
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-slate-100 mb-3">Suggested Next Steps</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-slate-300">
                    ${data.suggested_actions.map(action => `<li>${escapeHtml(action)}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    return html || '<p class="text-slate-400">No results to display</p>';
}

function formatSection(title, items, formatter) {
    if (!items || items.length === 0) return '';
    return `
        <div class="mb-6">
            <h3 class="text-lg font-semibold text-slate-100 mb-3">${title}</h3>
            ${items.map((item, i) => formatter(item, i)).join('')}
        </div>
    `;
}

function formatGenericResult(data) {
    if (!data) return '<p class="text-slate-400">No data returned</p>';

    // Pretty print object/array
    if (typeof data === 'object') {
        return `<pre class="bg-slate-900 p-4 rounded-lg overflow-x-auto text-sm text-slate-300">${JSON.stringify(data, null, 2)}</pre>`;
    }

    return `<div class="bg-slate-900 p-4 rounded-lg text-slate-300">${escapeHtml(String(data))}</div>`;
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function toggleExpand(id) {
    const preview = document.getElementById(`${id}-preview`);
    const full = document.getElementById(`${id}-full`);
    const btn = document.getElementById(`${id}-btn`);

    if (!full || !btn) return;

    const isExpanded = full.style.display !== 'none';

    if (isExpanded) {
        // Collapse
        preview.style.display = 'block';
        full.style.display = 'none';
        btn.innerHTML = 'Expand';
    } else {
        // Expand
        preview.style.display = 'none';
        full.style.display = 'block';
        btn.innerHTML = 'Collapse';
    }
}

function copyResults() {
    const json = document.getElementById('results-json').textContent;
    navigator.clipboard.writeText(json).then(() => {
        alert('Results copied to clipboard!');
    });
}

function clearForm() {
    document.getElementById('tool-form').reset();
}
</script>
{% endblock %}
